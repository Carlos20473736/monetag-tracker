<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Mini App - Monetag Tracker</title>
    
    <script>
        // IMPORTANTE: Modificar User Agent ANTES de qualquer coisa
        
        // 1. Modificar User Agent para Telegram Android
        Object.defineProperty(navigator, 'userAgent', {
            get: function() {
                return 'Mozilla/5.0 (Linux; Android 13) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Mobile Safari/537.36 Telegram-Android/10.6.2 (Samsung SM-G998B; Android 13; SDK 33; AVERAGE)';
            },
            configurable: true
        });

        // 2. Modificar platform
        Object.defineProperty(navigator, 'platform', {
            get: function() { return 'Linux armv8l'; },
            configurable: true
        });

        console.log('‚úÖ User Agent modificado');
        console.log('UA:', navigator.userAgent);
    </script>
    
    <!-- Telegram Web App SDK - OFICIAL -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <script>
        // Criar simula√ß√£o se o SDK oficial n√£o funcionar
        window.addEventListener('DOMContentLoaded', function() {
            const now = Math.floor(Date.now() / 1000);
            const userId = 1000000000 + Math.floor(Math.random() * 1000000000);
            
            // Verificar se o Telegram.WebApp foi carregado corretamente
            if (!window.Telegram || !window.Telegram.WebApp || !window.Telegram.WebApp.initDataUnsafe || !window.Telegram.WebApp.initDataUnsafe.user) {
                console.log('‚ö†Ô∏è SDK oficial do Telegram n√£o forneceu dados, criando simula√ß√£o...');
                
                // Criar objeto Telegram se n√£o existir
                if (!window.Telegram) {
                    window.Telegram = {};
                }
                
                // Criar ou completar WebApp
                window.Telegram.WebApp = {
                    initData: `query_id=AAHdF6IQAAAAAN0XohDhrOrc&user=%7B%22id%22%3A${userId}%2C%22first_name%22%3A%22User%22%2C%22last_name%22%3A%22Test%22%2C%22username%22%3A%22testuser%22%2C%22language_code%22%3A%22pt%22%2C%22allows_write_to_pm%22%3Atrue%7D&auth_date=${now}&hash=abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890`,
                    initDataUnsafe: {
                        query_id: 'AAHdF6IQAAAAAN0XohDhrOrc',
                        user: {
                            id: userId,
                            first_name: 'User',
                            last_name: 'Test',
                            username: 'testuser',
                            language_code: 'pt',
                            allows_write_to_pm: true,
                            is_premium: false
                        },
                        auth_date: now,
                        hash: 'abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890'
                    },
                    version: '7.0',
                    platform: 'android',
                    colorScheme: 'light',
                    themeParams: {
                        bg_color: '#ffffff',
                        text_color: '#000000',
                        hint_color: '#999999',
                        link_color: '#2481cc',
                        button_color: '#2481cc',
                        button_text_color: '#ffffff',
                        secondary_bg_color: '#f1f1f1'
                    },
                    isExpanded: true,
                    viewportHeight: window.innerHeight,
                    viewportStableHeight: window.innerHeight,
                    headerColor: '#ffffff',
                    backgroundColor: '#ffffff',
                    isClosingConfirmationEnabled: false,
                    ready: function() {
                        console.log('‚úÖ Telegram.WebApp.ready()');
                    },
                    expand: function() {
                        console.log('‚úÖ Telegram.WebApp.expand()');
                    },
                    close: function() {
                        console.log('‚úÖ Telegram.WebApp.close()');
                    },
                    MainButton: {
                        text: 'CONTINUAR',
                        color: '#2481cc',
                        textColor: '#ffffff',
                        isVisible: false,
                        isActive: true,
                        setText: function(text) { this.text = text; },
                        onClick: function(callback) { },
                        show: function() { this.isVisible = true; },
                        hide: function() { this.isVisible = false; }
                    },
                    BackButton: {
                        isVisible: false,
                        show: function() { this.isVisible = true; },
                        hide: function() { this.isVisible = false; }
                    },
                    HapticFeedback: {
                        impactOccurred: function(style) { },
                        notificationOccurred: function(type) { },
                        selectionChanged: function() { }
                    },
                    sendData: function(data) {
                        console.log('Telegram.WebApp.sendData:', data);
                    }
                };
                
                console.log('‚úÖ Ambiente Telegram simulado criado');
            } else {
                console.log('‚úÖ SDK oficial do Telegram funcionando');
            }
            
            console.log('User ID:', window.Telegram.WebApp.initDataUnsafe.user.id);
        });
    </script>
    
    <!-- Monetag SDK -->
    <script src='//libtl.com/sdk.js' data-zone='10269314' data-sdk='show_10269314'></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            max-width: 500px;
            width: 100%;
            background: white;
            border-radius: 20px;
            padding: 40px 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
        }

        h1 {
            font-size: 2rem;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 0.9rem;
        }

        .user-badge {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 30px;
            border: 1px solid #e2e8f0;
        }

        .user-id {
            color: #667eea;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-radius: 12px;
            padding: 15px 10px;
            border: 1px solid #e2e8f0;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2c3e50;
            margin: 5px 0;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ad-button {
            background: linear-gradient(135deg, #0088cc 0%, #006699 100%);
            color: white;
            border: none;
            padding: 18px 50px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,136,204,0.4);
            margin: 20px 0;
            width: 100%;
        }

        .ad-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,136,204,0.6);
        }

        .ad-button:active {
            transform: translateY(0);
        }

        .ad-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-weight: 500;
            display: none;
        }

        .status.show {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .info-box {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            font-size: 0.85rem;
            color: #6c757d;
            text-align: left;
        }

        .info-box strong {
            color: #2c3e50;
            display: block;
            margin-bottom: 10px;
        }

        .info-box p {
            margin: 5px 0;
            line-height: 1.5;
        }

        .emoji {
            font-size: 2.5rem;
            margin-bottom: 15px;
            display: block;
        }

        .dashboard-link {
            display: inline-block;
            margin-top: 20px;
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102,126,234,0.4);
        }

        .dashboard-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102,126,234,0.6);
        }
    </style>
</head>
<body>
    <div class="container">
        <span class="emoji">üéÆ</span>
        <h1>Telegram Ad Tracker</h1>
        <p class="subtitle">Monetiza√ß√£o com Monetag</p>
        
        <div class="user-badge">
            <div class="user-id">üë§ User ID: <span id="userId">Carregando...</span></div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="impressions">0</div>
                <div class="stat-label">Impress√µes</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="clicks">0</div>
                <div class="stat-label">Cliques</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="ctr">0%</div>
                <div class="stat-label">CTR</div>
            </div>
        </div>
        
        <button id="adBtn" class="ad-button">
            üéÅ Assistir An√∫ncio
        </button>
        
        <div id="status" class="status"></div>

        <a href="/dashboard" class="dashboard-link">üìä Ver Dashboard Completo</a>
        
        <div class="info-box">
            <strong>üí° Como funciona:</strong>
            <p>‚Ä¢ Clique no bot√£o para assistir um an√∫ncio</p>
            <p>‚Ä¢ An√∫ncio em tela cheia (Rewarded Interstitial)</p>
            <p>‚Ä¢ Eventos s√£o registrados automaticamente no backend</p>
            <p>‚Ä¢ Acesse o dashboard para ver estat√≠sticas detalhadas</p>
        </div>
    </div>

    <script>
        // Configura√ß√£o da API
        const API_BASE = window.location.origin;
        const ZONE_ID = '10269314';

        // Elementos
        const adBtn = document.getElementById('adBtn');
        const status = document.getElementById('status');
        const userIdSpan = document.getElementById('userId');
        const impressionsEl = document.getElementById('impressions');
        const clicksEl = document.getElementById('clicks');
        const ctrEl = document.getElementById('ctr');

        // Vari√°veis globais
        let currentUserId = null;
        let isPreloaded = false;

        // Mostrar status
        function showStatus(message, type) {
            status.textContent = message;
            status.className = 'status show ' + type;
            if (type !== 'loading') {
                setTimeout(() => status.classList.remove('show'), 5000);
            }
        }

        // Registrar evento no backend
        async function recordEvent(eventType, additionalData = {}) {
            if (!currentUserId) {
                console.warn('User ID n√£o dispon√≠vel, evento n√£o registrado');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/trpc/adEvents.recordEvent`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        eventType: eventType,
                        telegramId: currentUserId.toString(),
                        zoneId: ZONE_ID,
                        userAgent: navigator.userAgent,
                        ...additionalData
                    })
                });

                if (response.ok) {
                    console.log(`‚úÖ Evento ${eventType} registrado no backend`);
                    loadStats();
                } else {
                    console.error('‚ùå Erro ao registrar evento:', response.statusText);
                }
            } catch (error) {
                console.error('‚ùå Erro ao chamar API:', error);
            }
        }

        // Carregar estat√≠sticas
        async function loadStats() {
            if (!currentUserId) return;

            try {
                const response = await fetch(`${API_BASE}/api/trpc/adEvents.getByTelegramId?input=${encodeURIComponent(JSON.stringify({telegramId: currentUserId.toString(), limit: 100}))}`);
                
                if (response.ok) {
                    const data = await response.json();
                    const events = data.result?.data || [];
                    
                    const impressionCount = events.filter(e => e.eventType === 'impression').length;
                    const clickCount = events.filter(e => e.eventType === 'click').length;
                    const ctrValue = impressionCount > 0 ? ((clickCount / impressionCount) * 100).toFixed(1) : 0;

                    impressionsEl.textContent = impressionCount;
                    clicksEl.textContent = clickCount;
                    ctrEl.textContent = ctrValue + '%';
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar estat√≠sticas:', error);
            }
        }

        // Pr√©-carregar an√∫ncio
        function preloadAd() {
            console.log('üîÑ Pr√©-carregando an√∫ncio...');
            showStatus('üé¨ Preparando an√∫ncios...', 'loading');
            
            show_10269314({ type: 'preload', timeout: 5, ymid: currentUserId?.toString() })
                .then(() => {
                    isPreloaded = true;
                    console.log('‚úÖ An√∫ncio pr√©-carregado');
                    showStatus('‚úÖ Pronto! Clique para assistir.', 'success');
                    
                    // Registrar impress√£o ao pr√©-carregar
                    recordEvent('impression');
                })
                .catch((error) => {
                    isPreloaded = false;
                    console.warn('‚ö†Ô∏è Pr√©-carregamento falhou:', error);
                    showStatus('‚ö†Ô∏è Clique no bot√£o para carregar.', 'success');
                });
        }

        // Mostrar an√∫ncio
        function showAd() {
            adBtn.disabled = true;
            console.log('‚ñ∂Ô∏è Mostrando an√∫ncio...');
            showStatus('‚è≥ Carregando an√∫ncio...', 'loading');

            show_10269314({ 
                type: 'end',
                ymid: currentUserId?.toString(),
                requestVar: 'miniapp_click'
            })
                .then((result) => {
                    console.log('‚úÖ An√∫ncio visualizado com sucesso!', result);
                    
                    // Record impression when ad is shown
                    // Clicks will be recorded via Monetag postback to /api/monetag/postback
                    recordEvent('impression', {
                        clickId: result?.click_id,
                        revenue: result?.estimated_price?.toString()
                    });
                    
                    showStatus('‚úÖ An√∫ncio exibido!', 'success');
                    console.log('Impression recorded. Clicks will be tracked via Monetag postback.');
                    
                    isPreloaded = false;
                    setTimeout(preloadAd, 1000);
                })
                .catch((error) => {
                    console.error('‚ùå Erro:', error);
                    let msg = '‚ùå Erro ao carregar an√∫ncio.';
                    
                    if (error && error.message) {
                        const err = error.message.toLowerCase();
                        if (err.includes('network')) msg = 'üåê Erro de rede.';
                        else if (err.includes('timeout')) msg = '‚è±Ô∏è Tempo esgotado.';
                        else if (err.includes('no ad')) msg = 'üì≠ Sem an√∫ncios dispon√≠veis.';
                    }
                    
                    showStatus(msg, 'error');
                    setTimeout(preloadAd, 2000);
                })
                .finally(() => {
                    adBtn.disabled = false;
                });
        }

        // Event listener
        adBtn.addEventListener('click', showAd);

        // Inicializa√ß√£o
        window.addEventListener('load', () => {
            console.log('üìÑ P√°gina carregada');
            
            // Inicializar Telegram WebApp
            setTimeout(() => {
                if (window.Telegram && window.Telegram.WebApp) {
                    const tg = window.Telegram.WebApp;
                    tg.ready();
                    tg.expand();
                    
                    // Mostrar User ID
                    if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                        currentUserId = tg.initDataUnsafe.user.id;
                        userIdSpan.textContent = currentUserId;
                        console.log('‚úÖ Telegram WebApp inicializado');
                        console.log('üë§ User ID:', currentUserId);
                        
                        // Carregar estat√≠sticas do usu√°rio
                        loadStats();
                    } else {
                        userIdSpan.textContent = 'N/A';
                    }
                }
            }, 100);
            
            // Aguardar SDK Monetag
            console.log('üîç Aguardando SDK Monetag...');
            
            let attempts = 0;
            const check = setInterval(() => {
                attempts++;
                
                if (typeof show_10269314 === 'function') {
                    console.log('‚úÖ SDK Monetag carregado!');
                    console.log('üéØ Zone ID:', ZONE_ID);
                    clearInterval(check);
                    setTimeout(preloadAd, 500);
                } else if (attempts >= 20) {
                    console.error('‚ùå SDK n√£o carregou ap√≥s 10s');
                    clearInterval(check);
                    showStatus('‚ö†Ô∏è Erro ao carregar SDK.', 'error');
                }
            }, 500);
        });
    </script>
</body>
</html>
